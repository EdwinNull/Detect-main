{% extends "shared/base.html" %}

{% block title %}ç”¨æˆ·ç®¡ç† - å¼€æºç»„ä»¶åŒ…å®‰å…¨æ£€æµ‹å¹³å°{% endblock %}

{% block content %}
<div class="user-management-container" style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <h2 style="margin-bottom: 20px; color: #667eea;">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
    
    <!-- ç”¨æˆ·ç»Ÿè®¡ -->
    <div style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">
        <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 8px; min-width: 150px; text-align: center; flex: 1;">
            <div style="font-size: 24px; font-weight: bold; color: #667eea;">{{ total_users }}</div>
            <div style="color: #666; font-size: 14px;">æ€»ç”¨æˆ·æ•°</div>
        </div>
        <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 8px; min-width: 150px; text-align: center; flex: 1;">
            <div style="font-size: 24px; font-weight: bold; color: #667eea;">{{ admin_count }}</div>
            <div style="color: #666; font-size: 14px;">ç®¡ç†å‘˜æ•°</div>
        </div>
        <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 8px; min-width: 150px; text-align: center; flex: 1;">
            <div style="font-size: 24px; font-weight: bold; color: #667eea;">{{ active_users }}</div>
            <div style="color: #666; font-size: 14px;">æ´»è·ƒç”¨æˆ·</div>
        </div>
    </div>
    
    <!-- å¿«é€Ÿæ“ä½œåŒºåŸŸ -->
    <div style="margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
        <h3 style="margin-bottom: 20px; font-size: 20px;">ğŸš€ å¿«é€Ÿæ“ä½œ</h3>
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <button onclick="showAddUserForm()" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease;">
                â• æ·»åŠ æ–°ç”¨æˆ·
            </button>
            <button onclick="showBulkAddForm()" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease;">
                ğŸ“ æ‰¹é‡æ·»åŠ ç”¨æˆ·
            </button>
            <button onclick="exportUsers()" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease;">
                ğŸ“Š å¯¼å‡ºç”¨æˆ·åˆ—è¡¨
            </button>
        </div>
    </div>
    
    <!-- æ·»åŠ ç”¨æˆ·è¡¨å• (é»˜è®¤éšè—) -->
    <div id="addUserForm" style="display: none; margin-bottom: 30px; padding: 25px; border: 2px solid #667eea; border-radius: 12px; background: rgba(102, 126, 234, 0.05);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="font-size: 18px; color: #667eea; margin: 0;">â• æ·»åŠ æ–°ç”¨æˆ·</h3>
            <button onclick="hideAddUserForm()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">âœ•</button>
        </div>
        <form method="POST" action="{{ url_for('admin.add_user') }}" id="userForm">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ‘¤ ç”¨æˆ·å *</label>
                    <input type="text" name="username" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">ç”¨æˆ·åå°†ç”¨äºç™»å½•ç³»ç»Ÿ</div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ“§ é‚®ç®±åœ°å€ *</label>
                    <input type="email" name="email" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="user@example.com">
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">ç”¨äºå¯†ç é‡ç½®å’Œé€šçŸ¥</div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ”’ åˆå§‹å¯†ç  *</label>
                    <input type="password" name="password" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="è¯·è¾“å…¥åˆå§‹å¯†ç ">
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">å»ºè®®ä½¿ç”¨8ä½ä»¥ä¸Šå¯†ç </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ‘‘ ç”¨æˆ·è§’è‰²</label>
                    <select name="role" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="user">ğŸ‘¤ æ™®é€šç”¨æˆ· - å¯ä»¥æ‰«æå’ŒæŸ¥çœ‹ç»“æœ</option>
                        <option value="admin">ğŸ‘‘ ç®¡ç†å‘˜ - å¯ä»¥ç®¡ç†ç”¨æˆ·å’Œç³»ç»Ÿ</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">é€‰æ‹©ç”¨æˆ·çš„æƒé™çº§åˆ«</div>
                </div>
            </div>
            <div style="display: flex; gap: 15px;">
                <button type="submit" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                    âœ… ç¡®è®¤æ·»åŠ ç”¨æˆ·
                </button>
                <button type="button" onclick="hideAddUserForm()" style="background: #e2e8f0; color: #333; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                    âŒ å–æ¶ˆ
                </button>
            </div>
        </form>
    </div>
    
    <!-- æ‰¹é‡æ·»åŠ ç”¨æˆ·è¡¨å• (é»˜è®¤éšè—) -->
    <div id="bulkAddForm" style="display: none; margin-bottom: 30px; padding: 25px; border: 2px solid #667eea; border-radius: 12px; background: rgba(102, 126, 234, 0.05);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="font-size: 18px; color: #667eea; margin: 0;">ğŸ“ æ‰¹é‡æ·»åŠ ç”¨æˆ·</h3>
            <button onclick="hideBulkAddForm()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">âœ•</button>
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ“‹ ç”¨æˆ·ä¿¡æ¯ (æ¯è¡Œä¸€ä¸ªç”¨æˆ·)</label>
            <textarea id="bulkUsers" rows="8" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="æ ¼å¼ï¼šç”¨æˆ·å,é‚®ç®±,å¯†ç ,è§’è‰²&#10;ä¾‹å¦‚ï¼š&#10;user1,user1@example.com,password123,user&#10;user2,user2@example.com,password123,admin"></textarea>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">æ¯è¡Œæ ¼å¼ï¼šç”¨æˆ·å,é‚®ç®±,å¯†ç ,è§’è‰²(å¯é€‰ï¼Œé»˜è®¤ä¸ºuser)</div>
        </div>
        <div style="display: flex; gap: 15px;">
            <button onclick="bulkAddUsers()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                âœ… æ‰¹é‡æ·»åŠ 
            </button>
            <button onclick="hideBulkAddForm()" style="background: #e2e8f0; color: #333; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                âŒ å–æ¶ˆ
            </button>
        </div>
    </div>
    
    <!-- ç”¨æˆ·åˆ—è¡¨ -->
    <div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="font-size: 18px; color: #333; margin: 0;">ğŸ“‹ ç”¨æˆ·åˆ—è¡¨</h3>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="userSearchInput" placeholder="ğŸ” æœç´¢ç”¨æˆ·åæˆ–é‚®ç®±..." style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; width: 250px;" onkeyup="filterUsers()">
                <select id="roleFilter" onchange="filterUsers()" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                    <option value="">æ‰€æœ‰è§’è‰²</option>
                    <option value="admin">ç®¡ç†å‘˜</option>
                    <option value="user">æ™®é€šç”¨æˆ·</option>
                </select>
            </div>
        </div>
        
        <div style="overflow-x: auto; border-radius: 8px; border: 1px solid #ddd;">
            <table style="width: 100%; border-collapse: collapse; text-align: left;" id="userTable">
                <thead>
                    <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 15px;">
                        <th style="padding: 15px; border-bottom: 1px solid #ddd; font-weight: 600;">ID</th>
                        <th style="padding: 15px; border-bottom: 1px solid #ddd; font-weight: 600;">ç”¨æˆ·å</th>
                        <th style="padding: 15px; border-bottom: 1px solid #ddd; font-weight: 600;">é‚®ç®±</th>
                        <th style="padding: 15px; border-bottom: 1px solid #ddd; font-weight: 600;">è§’è‰²</th>
                        <th style="padding: 15px; border-bottom: 1px solid #ddd; font-weight: 600;">æ³¨å†Œæ—¶é—´</th>
                        <th style="padding: 15px; border-bottom: 1px solid #ddd; font-weight: 600;">ä¸Šæ¬¡ç™»å½•</th>
                        <th style="padding: 15px; border-bottom: 1px solid #ddd; font-weight: 600;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr style="border-bottom: 1px solid #eee; font-size: 15px; color: #222; font-weight: 500; background: #fff; transition: background 0.2s;">
                        <td style="padding: 15px;">{{ user.id }}</td>
                        <td style="padding: 15px; font-weight: 600; color: #222;">{{ user.username }}</td>
                        <td style="padding: 15px; color: #222;">{{ user.email }}</td>
                        <td style="padding: 15px;">
                            {% if user.role == 'admin' %}
                            <span style="background: #667eea; color: white; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">ç®¡ç†å‘˜</span>
                            {% else %}
                            <span style="background: #e2e8f0; color: #333; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">æ™®é€šç”¨æˆ·</span>
                            {% endif %}
                        </td>
                        <td style="padding: 15px; color: #666;">{{ user.created_at or 'æœªçŸ¥' }}</td>
                        <td style="padding: 15px; color: #666;">{{ user.last_login or 'ä»æœªç™»å½•' }}</td>
                        <td style="padding: 15px;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" style="text-decoration: none; background: #4299e1; color: white; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600;">ç¼–è¾‘</a>
                                {% if user.username != 'admin' %}
                                <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.id) }}" onsubmit="return confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤ç”¨æˆ· {{ user.username }} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼');" style="display: inline;">
                                    <button type="submit" style="background: #e53e3e; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">åˆ é™¤</button>
                                </form>
                                {% endif %}
                                <form method="POST" action="{{ url_for('admin.reset_password', user_id=user.id) }}" onsubmit="return confirm('ç¡®å®šè¦é‡ç½®ç”¨æˆ· {{ user.username }} çš„å¯†ç å—ï¼Ÿ');" style="display: inline;">
                                    <button type="submit" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">é‡ç½®å¯†ç </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function showAddUserForm() {
    document.getElementById('addUserForm').style.display = 'block';
    document.getElementById('bulkAddForm').style.display = 'none';
}

function hideAddUserForm() {
    document.getElementById('addUserForm').style.display = 'none';
}

function showBulkAddForm() {
    document.getElementById('bulkAddForm').style.display = 'block';
    document.getElementById('addUserForm').style.display = 'none';
}

function hideBulkAddForm() {
    document.getElementById('bulkAddForm').style.display = 'none';
}

function bulkAddUsers() {
    const usersText = document.getElementById('bulkUsers').value;
    if (!usersText.trim()) {
        alert('è¯·è¾“å…¥ç”¨æˆ·ä¿¡æ¯');
        return;
    }
    
    if (confirm('ç¡®å®šè¦æ‰¹é‡æ·»åŠ è¿™äº›ç”¨æˆ·å—ï¼Ÿ')) {
        // è¿™é‡Œå¯ä»¥æ·»åŠ æ‰¹é‡æ·»åŠ çš„é€»è¾‘
        alert('æ‰¹é‡æ·»åŠ åŠŸèƒ½å¼€å‘ä¸­...');
    }
}

function exportUsers() {
    // å¯¼å‡ºç”¨æˆ·åˆ—è¡¨åŠŸèƒ½
    alert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
}

function filterUsers() {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("userSearchInput");
    filter = input.value.toUpperCase();
    table = document.getElementById("userTable");
    tr = table.getElementsByTagName("tr");
    
    var roleFilter = document.getElementById("roleFilter").value;
    // è§’è‰²è‹±æ–‡åˆ°ä¸­æ–‡çš„æ˜ å°„
    var roleMap = {
        'admin': 'ç®¡ç†å‘˜',
        'user': 'æ™®é€šç”¨æˆ·'
    };
    var roleFilterText = roleMap[roleFilter] || '';
    // ä»ç´¢å¼•1å¼€å§‹ï¼Œè·³è¿‡è¡¨å¤´
    for (i = 1; i < tr.length; i++) {
        let usernameCol = tr[i].getElementsByTagName("td")[1];
        let emailCol = tr[i].getElementsByTagName("td")[2];
        let roleCol = tr[i].getElementsByTagName("td")[3];
        
        if (usernameCol && emailCol && roleCol) {
            let usernameValue = usernameCol.textContent || usernameCol.innerText;
            let emailValue = emailCol.textContent || emailCol.innerText;
            let roleValue = roleCol.textContent || roleCol.innerText;
            
            let matchesSearch = usernameValue.toUpperCase().indexOf(filter) > -1 || 
                               emailValue.toUpperCase().indexOf(filter) > -1;
            let matchesRole = !roleFilter || roleValue.indexOf(roleFilterText) > -1;
            
            if (matchesSearch && matchesRole) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }
}

// é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæç¤º
document.addEventListener('DOMContentLoaded', function() {
    // å¯ä»¥æ·»åŠ ä¸€äº›åˆå§‹åŒ–é€»è¾‘
});
</script>
{% endblock %} 