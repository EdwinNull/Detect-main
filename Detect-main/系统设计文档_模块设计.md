# 2.2.2 分解描述

## 2.2.2.1 用户认证模块

**1、简介**

用户认证模块负责系统的用户管理、登录认证、权限控制等功能，确保系统安全性和用户数据的隔离。

**2、功能列表**

- 用户注册
- 用户登录
- 密码加密
- 会话管理
- 权限验证

### 2.2.2.1.1 用户注册功能

**1 功能设计描述**

**（1）类**

**1）User类**

负责用户数据的封装和基本操作。

```plantuml
@startuml
class User {
    -id: Integer
    -username: String
    -email: String
    -password_hash: String
    -role: String
    -last_login: DateTime
    +get_by_username(username): User
    +get_by_id(user_id): User
    +save(): Boolean
    +delete(): Boolean
}
@enduml
```

**2）AuthService类**

负责用户认证相关的业务逻辑。

```plantuml
@startuml
class AuthService {
    +register_user(username, email, password): Boolean
    +login_user(username, password): User
    +logout_user(): Boolean
    +verify_password(password, hash): Boolean
    +hash_password(password): String
}
@enduml
```

**（2）类与类之间关系**

```plantuml
@startuml
AuthService --> User : 使用
User --> Database : 存储
@enduml
```

**（3）文件列表**

|     |     |     |     |
| --- | --- | --- | --- |
| 名称  | 类型  | 存放位置 | 说明  |
| auth.py | Python | app/routes/auth.py | 认证路由控制器 |
| db_models.py | Python | app/models/db_models.py | 用户数据模型 |
| login.html | HTML | app/templates/login.html | 登录页面 |
| register.html | HTML | app/templates/register.html | 注册页面 |

**2 功能实现说明**

```plantuml
@startuml
actor User
participant "Web界面" as Web
participant "AuthService" as Auth
participant "User" as UserModel
participant "Database" as DB

User -> Web: 填写注册信息
Web -> Auth: register_user(username, email, password)
Auth -> Auth: hash_password(password)
Auth -> UserModel: 创建用户对象
UserModel -> DB: 保存用户数据
DB -> UserModel: 返回结果
UserModel -> Auth: 返回注册结果
Auth -> Web: 返回注册状态
Web -> User: 显示注册结果
@enduml
```

## 2.2.2.2 包扫描检测模块

**1、简介**

包扫描检测模块是系统的核心功能模块，负责接收用户上传的包文件，进行特征提取、安全分析，并生成检测报告。

**2、功能列表**

- 文件上传处理
- 包类型检测
- 特征提取
- 扫描状态管理
- 结果存储

### 2.2.2.2.1 文件上传功能

**1 功能设计描述**

**（1）类**

**1）ScanRecord类**

负责扫描记录的数据封装。

```plantuml
@startuml
class ScanRecord {
    -id: Integer
    -user_id: Integer
    -filename: String
    -file_size: Integer
    -file_hash: String
    -risk_level: String
    -confidence: Float
    -scan_status: String
    -created_at: DateTime
    -scan_time: DateTime
    -package_type: String
    -result: String
    +get_by_id(id): ScanRecord
    +save(): Boolean
    +update_status(status): Boolean
}
@enduml
```

**2）ScanService类**

负责扫描相关的业务逻辑。

```plantuml
@startuml
class ScanService {
    +upload_file(file, user_id): Integer
    +extract_features(file_path): Dict
    +detect_package_type(file_path): String
    +calculate_file_hash(file_path): String
    +update_scan_status(scan_id, status): Boolean
}
@enduml
```

**（2）类与类之间关系**

```plantuml
@startuml
ScanService --> ScanRecord : 使用
ScanService --> FeatureExtractor : 使用
ScanRecord --> Database : 存储
@enduml
```

**（3）文件列表**

|     |     |     |     |
| --- | --- | --- | --- |
| 名称  | 类型  | 存放位置 | 说明  |
| scan.py | Python | app/routes/scan.py | 扫描路由控制器 |
| extractor.py | Python | app/services/extractor.py | 特征提取服务 |
| scan.html | HTML | app/templates/scan.html | 扫描上传页面 |
| progress.html | HTML | app/templates/progress.html | 扫描进度页面 |

**2 功能实现说明**

```plantuml
@startuml
actor User
participant "Web界面" as Web
participant "ScanService" as Scan
participant "FeatureExtractor" as Extractor
participant "ScanRecord" as Record
participant "Database" as DB

User -> Web: 上传文件
Web -> Scan: upload_file(file, user_id)
Scan -> Scan: 保存文件
Scan -> Scan: 计算文件哈希
Scan -> Scan: 检测包类型
Scan -> Record: 创建扫描记录
Record -> DB: 保存记录
Scan -> Extractor: 提取特征
Extractor -> Scan: 返回特征数据
Scan -> Record: 更新特征数据
Scan -> Web: 返回扫描ID
Web -> User: 显示上传成功
@enduml
```

## 2.2.2.3 机器学习分析模块

**1、简介**

机器学习分析模块使用XGBoost等机器学习算法对提取的特征进行分析，识别潜在的恶意行为。

**2、功能列表**

- 模型加载
- 特征预处理
- 风险预测
- 置信度计算
- 特征重要性分析

### 2.2.2.3.1 风险预测功能

**1 功能设计描述**

**（1）类**

**1）SecurityClassifier类**

负责机器学习模型的加载和预测。

```plantuml
@startuml
class SecurityClassifier {
    -model: XGBClassifier
    -model_type: String
    -feature_names: List
    -is_trained: Boolean
    +__init__(model_type): void
    +predict(features): Dict
    +calculate_risk_score(features): Float
    +get_risk_level(risk_score): String
    +get_feature_importance(features): Dict
    -_initialize_model(): void
    -_train_model(): void
}
@enduml
```

**2）FeatureProcessor类**

负责特征数据的预处理。

```plantuml
@startuml
class FeatureProcessor {
    +normalize_features(features): List
    +validate_features(features): Boolean
    +extract_key_features(features): Dict
    +calculate_statistics(features): Dict
}
@enduml
```

**（2）类与类之间关系**

```plantuml
@startuml
SecurityClassifier --> FeatureProcessor : 使用
SecurityClassifier --> XGBoost : 使用
FeatureProcessor --> Features : 处理
@enduml
```

**（3）文件列表**

|     |     |     |     |
| --- | --- | --- | --- |
| 名称  | 类型  | 存放位置 | 说明  |
| classifier.py | Python | app/services/classifier.py | 机器学习分类器 |
| xgboost_model.pkl | Model | models/xgboost_model.pkl | XGBoost模型文件 |
| feature_names.txt | Text | data/feature_names.txt | 特征名称列表 |

**2 功能实现说明**

```plantuml
@startuml
participant "ScanService" as Scan
participant "SecurityClassifier" as Classifier
participant "FeatureProcessor" as Processor
participant "XGBoost" as Model
participant "Database" as DB

Scan -> Classifier: predict(features)
Classifier -> Processor: normalize_features(features)
Processor -> Classifier: 返回标准化特征
Classifier -> Model: 加载模型
Model -> Classifier: 返回预测结果
Classifier -> Classifier: calculate_risk_score()
Classifier -> Classifier: get_risk_level()
Classifier -> Classifier: get_feature_importance()
Classifier -> Scan: 返回预测结果
Scan -> DB: 保存结果
@enduml
```

## 2.2.2.4 AI深度分析模块

**1、简介**

AI深度分析模块使用DeepSeek等大语言模型对包进行深度分析，提供更详细的安全风险评估和解释。

**2、功能列表**

- AI模型调用
- 分析提示构建
- 结果解析
- 风险解释
- 建议生成

### 2.2.2.4.1 AI分析功能

**1 功能设计描述**

**（1）类**

**1）DeepSeekAnalyzer类**

负责AI深度分析的核心功能。

```plantuml
@startuml
class DeepSeekAnalyzer {
    -api_key: String
    -api_url: String
    +__init__(api_key): void
    +analyze_package(filename, features, xgboost_result): Dict
    -_build_analysis_prompt(filename, features, xgboost_result): String
    -_parse_analysis(analysis_text, xgboost_result): Dict
    -_fallback_analysis(xgboost_result): Dict
    -_convert_markdown_to_friendly_text(markdown_text): String
}
@enduml
```

**2）AnalysisResult类**

负责分析结果的数据封装。

```plantuml
@startuml
class AnalysisResult {
    -risk_level: String
    -confidence: Float
    -type: String
    -reason: String
    -top_features: List
    -risk_points: String
    -advice_list: List
    -raw_analysis: String
    +to_dict(): Dict
    +from_dict(data): AnalysisResult
}
@enduml
```

**（2）类与类之间关系**

```plantuml
@startuml
DeepSeekAnalyzer --> AnalysisResult : 生成
DeepSeekAnalyzer --> DeepSeekAPI : 调用
AnalysisResult --> Database : 存储
@enduml
```

**（3）文件列表**

|     |     |     |     |
| --- | --- | --- | --- |
| 名称  | 类型  | 存放位置 | 说明  |
| analyzer.py | Python | app/services/analyzer.py | AI分析服务 |
| config.py | Python | config/config.py | API配置 |
| analysis_prompts.py | Python | app/utils/analysis_prompts.py | 分析提示模板 |

**2 功能实现说明**

```plantuml
@startuml
participant "ScanService" as Scan
participant "DeepSeekAnalyzer" as Analyzer
participant "DeepSeekAPI" as API
participant "AnalysisResult" as Result
participant "Database" as DB

Scan -> Analyzer: analyze_package(filename, features, xgboost_result)
Analyzer -> Analyzer: _build_analysis_prompt()
Analyzer -> API: 发送分析请求
API -> Analyzer: 返回分析结果
Analyzer -> Analyzer: _parse_analysis()
Analyzer -> Result: 创建分析结果对象
Result -> Analyzer: 返回结果对象
Analyzer -> Scan: 返回分析结果
Scan -> DB: 保存AI分析结果
@enduml
```

## 2.2.2.5 社区功能模块

**1、简介**

社区功能模块提供用户交流、异常报告、知识分享等功能，增强系统的社区属性。

**2、功能列表**

- 异常报告
- 社区讨论
- 知识分享
- 用户互动

### 2.2.2.5.1 异常报告功能

**1 功能设计描述**

**（1）类**

**1）AnomalyReport类**

负责异常报告的数据管理。

```plantuml
@startuml
class AnomalyReport {
    -id: Integer
    -user_id: Integer
    -scan_record_id: Integer
    -title: String
    -description: String
    -reason: String
    -status: String
    -created_at: DateTime
    +save(): Boolean
    +get_latest(limit): List
    +get_all(): List
}
@enduml
```

**2）CommunityService类**

负责社区功能的业务逻辑。

```plantuml
@startuml
class CommunityService {
    +create_report(user_id, scan_id, title, description, reason): Boolean
    +get_reports(limit): List
    +update_report_status(report_id, status): Boolean
    +search_reports(query): List
}
@enduml
```

**（2）类与类之间关系**

```plantuml
@startuml
CommunityService --> AnomalyReport : 使用
CommunityService --> User : 关联
AnomalyReport --> ScanRecord : 关联
@enduml
```

**（3）文件列表**

|     |     |     |     |
| --- | --- | --- | --- |
| 名称  | 类型  | 存放位置 | 说明  |
| community.py | Python | app/routes/community.py | 社区路由控制器 |
| community_models.py | Python | app/models/community_models.py | 社区数据模型 |
| community.html | HTML | app/templates/community/index.html | 社区主页 |
| report_anomaly.html | HTML | app/templates/community/report_anomaly.html | 异常报告页面 |

## 2.2.2.6 管理功能模块

**1、简介**

管理功能模块为管理员提供系统管理、用户管理、数据统计等功能。

**2、功能列表**

- 用户管理
- 系统配置
- 数据统计
- 模型管理

### 2.2.2.6.1 用户管理功能

**1 功能设计描述**

**（1）类**

**1）AdminService类**

负责管理员功能的业务逻辑。

```plantuml
@startuml
class AdminService {
    +get_all_users(): List
    +update_user_role(user_id, role): Boolean
    +delete_user(user_id): Boolean
    +get_system_stats(): Dict
    +get_scan_statistics(): Dict
}
@enduml
```

**2）UserManagement类**

负责用户管理的具体操作。

```plantuml
@startuml
class UserManagement {
    +list_users(): List
    +edit_user(user_id, data): Boolean
    +delete_user(user_id): Boolean
    +reset_user_password(user_id): Boolean
}
@enduml
```

**（2）类与类之间关系**

```plantuml
@startuml
AdminService --> UserManagement : 使用
AdminService --> User : 管理
UserManagement --> Database : 操作
@enduml
```

**（3）文件列表**

|     |     |     |     |
| --- | --- | --- | --- |
| 名称  | 类型  | 存放位置 | 说明  |
| admin.py | Python | app/routes/admin.py | 管理路由控制器 |
| admin.html | HTML | app/templates/admin.html | 管理主页 |
| user_management.html | HTML | app/templates/user_management.html | 用户管理页面 |

## 2.2.3 接口描述

### 2.2.3.1 文件上传接口

**Name名称：** upload_file

**Description说明：** 处理用户上传的包文件，启动扫描流程

**Definition定义：**
```python
POST /upload
Content-Type: multipart/form-data

Parameters:
- file: File (required) - 上传的包文件
- user_id: Integer (required) - 用户ID

Response:
{
    "success": Boolean,
    "scan_id": Integer,
    "message": String
}
```

### 2.2.3.2 扫描状态查询接口

**Name名称：** get_scan_status

**Description说明：** 查询扫描任务的当前状态和进度

**Definition定义：**
```python
GET /scan_status/<scan_id>

Parameters:
- scan_id: Integer (required) - 扫描ID

Response:
{
    "status": String,  // pending, processing, completed, failed
    "progress": Integer,  // 0-100
    "current_task": String
}
```

### 2.2.3.3 结果获取接口

**Name名称：** get_scan_results

**Description说明：** 获取扫描的详细结果和分析报告

**Definition定义：**
```python
GET /results/<scan_id>

Parameters:
- scan_id: Integer (required) - 扫描ID

Response:
{
    "id": Integer,
    "filename": String,
    "risk_level": String,
    "confidence": Float,
    "xgboost_result": Object,
    "llm_result": Object,
    "features": Object,
    "malicious_code_snippet": String,
    "code_location": String,
    "malicious_action": String,
    "technical_details": String
}
``` 