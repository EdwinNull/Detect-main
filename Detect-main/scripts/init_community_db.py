#!/usr/bin/env python3
"""
ç¤¾åŒºåŠŸèƒ½æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
"""
import sqlite3
import os
import sys
import json
from datetime import datetime
import hashlib
import uuid
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from config.config import Config

from app.models.community_models import CommunityPost

def init_community_database():
    """åˆå§‹åŒ–ç¤¾åŒºæ•°æ®åº“è¡¨"""
    print("ğŸ”§ æ­£åœ¨åˆå§‹åŒ–ç¤¾åŒºæ•°æ®åº“...")
    
    try:
        # åˆ›å»ºç¤¾åŒºç›¸å…³æ•°æ®è¡¨
        CommunityPost.create_tables()
        print("âœ… ç¤¾åŒºæ•°æ®è¡¨åˆ›å»ºæˆåŠŸï¼")
        
        # æ·»åŠ ä¸€äº›ç¤ºä¾‹æ•°æ®
        add_sample_data()
        print("âœ… ç¤ºä¾‹æ•°æ®æ·»åŠ æˆåŠŸï¼")
        
        print("ğŸ‰ ç¤¾åŒºæ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼")
        
    except Exception as e:
        print(f"âŒ åˆå§‹åŒ–å¤±è´¥: {e}")
        return False
    
    return True

def add_sample_data():
    """æ·»åŠ ç¤ºä¾‹æ•°æ®"""
    from app.models.db_models import User
    
    # è·å–æˆ–åˆ›å»ºæµ‹è¯•ç”¨æˆ·
    test_user = User.get_by_username('admin')
    if not test_user:
        print("âš ï¸  æœªæ‰¾åˆ°adminç”¨æˆ·ï¼Œè·³è¿‡ç¤ºä¾‹æ•°æ®æ·»åŠ ")
        return
    
    # æ·»åŠ ç¤ºä¾‹å¸–å­
    sample_posts = [
        {
            'title': 'å‘ç°å¯ç–‘çš„npmåŒ…ï¼šfake-login-form',
            'content': '''æ£€æµ‹å‘ç°ï¼šfake-login-form

é£é™©ç­‰çº§ï¼šhigh
ç½®ä¿¡åº¦ï¼š95.2%

è¯¦ç»†åˆ†æï¼š
è¿™ä¸ªnpmåŒ…ä¼ªè£…æˆç™»å½•è¡¨å•ç»„ä»¶ï¼Œä½†å®é™…ä¸Šä¼šæ”¶é›†ç”¨æˆ·çš„ç™»å½•å‡­æ®å¹¶å‘é€åˆ°è¿œç¨‹æœåŠ¡å™¨ã€‚åŒ…åæ•…æ„æ¨¡ä»¿äº†æµè¡Œçš„login-formç»„ä»¶ï¼Œå®¹æ˜“è¯¯å¯¼å¼€å‘è€…ã€‚

ä¸»è¦ç‰¹å¾ï¼š
1. åŒ…åå…·æœ‰è¿·æƒ‘æ€§ï¼Œæ¨¡ä»¿çŸ¥åç»„ä»¶
2. ä»£ç ä¸­åŒ…å«æ•°æ®æ”¶é›†å’Œç½‘ç»œè¯·æ±‚åŠŸèƒ½
3. æ–‡æ¡£æè¿°ä¸å®é™…åŠŸèƒ½ä¸ç¬¦
4. å‘å¸ƒè€…è´¦å·ä¸ºæ–°æ³¨å†Œï¼Œæ— å…¶ä»–å¯ä¿¡é¡¹ç›®

é˜²æŠ¤å»ºè®®ï¼š
1. ä»”ç»†æ£€æŸ¥åŒ…åï¼Œé¿å…ä½¿ç”¨ç›¸ä¼¼åç§°çš„åŒ…
2. æŸ¥çœ‹åŒ…çš„ä¸‹è½½é‡ã€è¯„åˆ†å’Œè¯„è®º
3. æ£€æŸ¥å‘å¸ƒè€…çš„å…¶ä»–é¡¹ç›®å’Œå†å²
4. ä½¿ç”¨å®‰å…¨æ‰«æå·¥å…·è¿›è¡Œæ£€æµ‹
5. åœ¨æµ‹è¯•ç¯å¢ƒä¸­å…ˆéªŒè¯åŒ…çš„åŠŸèƒ½''',
            'package_name': 'fake-login-form',
            'package_type': 'npm',
            'risk_level': 'high',
            'confidence': 95.2
        },
        {
            'title': 'PyPIæ¶æ„åŒ…åˆ†æï¼šmalicious-utils',
            'content': '''æ£€æµ‹å‘ç°ï¼šmalicious-utils

é£é™©ç­‰çº§ï¼šmedium
ç½®ä¿¡åº¦ï¼š87.5%

è¯¦ç»†åˆ†æï¼š
è¿™ä¸ªPyPIåŒ…å£°ç§°æä¾›å®ç”¨å·¥å…·å‡½æ•°ï¼Œä½†åŒ…å«æ¶æ„ä»£ç ï¼Œä¼šåœ¨å®‰è£…æ—¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤å¹¶æ”¶é›†ç³»ç»Ÿä¿¡æ¯ã€‚

æ¶æ„è¡Œä¸ºï¼š
1. åœ¨setup.pyä¸­æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
2. æ”¶é›†ä¸»æœºåã€ç”¨æˆ·åç­‰ç³»ç»Ÿä¿¡æ¯
3. å°è¯•å»ºç«‹ç½‘ç»œè¿æ¥
4. éšè—çœŸå®çš„æ¶æ„åŠŸèƒ½

æŠ€æœ¯ç»†èŠ‚ï¼š
- ä½¿ç”¨base64ç¼–ç éšè—æ¶æ„ä»£ç 
- åœ¨å®‰è£…è¿‡ç¨‹ä¸­æ‰§è¡Œå‘½ä»¤
- ä¼ªè£…æˆæ­£å¸¸çš„å·¥å…·åŒ…

é˜²æŠ¤å»ºè®®ï¼š
1. ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒå®‰è£…åŒ…
2. æ£€æŸ¥setup.pyæ–‡ä»¶å†…å®¹
3. ç›‘æ§ç½‘ç»œè¿æ¥å’Œç³»ç»Ÿè°ƒç”¨
4. ä½¿ç”¨å®‰å…¨æ‰«æå·¥å…·
5. å®šæœŸæ›´æ–°ä¾èµ–åŒ…''',
            'package_name': 'malicious-utils',
            'package_type': 'pypi',
            'risk_level': 'medium',
            'confidence': 87.5
        },
        {
            'title': 'å¦‚ä½•è¯†åˆ«ä¾›åº”é“¾æ”»å‡»ä¸­çš„æ¶æ„åŒ…',
            'content': '''ä¾›åº”é“¾æ”»å‡»æ˜¯å½“å‰æœ€ä¸¥é‡çš„å®‰å…¨å¨èƒä¹‹ä¸€ï¼Œæ¶æ„åŒ…æ˜¯å…¶ä¸»è¦è½½ä½“ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›è¯†åˆ«æŠ€å·§ï¼š

1. åŒ…åæ£€æŸ¥
- æ£€æŸ¥æ˜¯å¦æœ‰æ‹¼å†™é”™è¯¯æˆ–ç›¸ä¼¼åç§°
- æ³¨æ„åŒ…åçš„åˆç†æ€§
- é¿å…ä½¿ç”¨æ–°æ³¨å†Œçš„ç›¸ä¼¼åŒ…å

2. å‘å¸ƒè€…ä¿¡æ¯
- æŸ¥çœ‹å‘å¸ƒè€…çš„æ³¨å†Œæ—¶é—´
- æ£€æŸ¥å‘å¸ƒè€…çš„å…¶ä»–é¡¹ç›®
- æ³¨æ„å‘å¸ƒè€…çš„æ´»è·ƒåº¦

3. ä»£ç å®¡æŸ¥
- æŸ¥çœ‹æºä»£ç ï¼ˆå¦‚æœæœ‰ï¼‰
- æ£€æŸ¥ä¾èµ–å…³ç³»
- æ³¨æ„å¯ç–‘çš„ç½‘ç»œè¯·æ±‚

4. ç¤¾åŒºåé¦ˆ
- æŸ¥çœ‹ä¸‹è½½é‡å’Œè¯„åˆ†
- é˜…è¯»ç”¨æˆ·è¯„è®º
- å…³æ³¨å®‰å…¨å…¬å‘Š

5. å·¥å…·è¾…åŠ©
- ä½¿ç”¨å®‰å…¨æ‰«æå·¥å…·
- é…ç½®ä¾èµ–æ£€æŸ¥
- å®šæœŸæ›´æ–°ä¾èµ–

è®°ä½ï¼šå®‰å…¨æ°¸è¿œæ˜¯ç¬¬ä¸€ä½çš„ï¼Œå®å¯å¤šèŠ±æ—¶é—´æ£€æŸ¥ï¼Œä¹Ÿä¸è¦å†’é™©ä½¿ç”¨å¯ç–‘çš„åŒ…ã€‚''',
            'package_name': None,
            'package_type': None,
            'risk_level': None,
            'confidence': None
        }
    ]
    
    for post_data in sample_posts:
        CommunityPost.create_post(
            user_id=test_user.id,
            title=post_data['title'],
            content=post_data['content'],
            package_name=post_data['package_name'],
            package_type=post_data['package_type'],
            risk_level=post_data['risk_level'],
            confidence=post_data['confidence']
        )

if __name__ == '__main__':
    init_community_database() 